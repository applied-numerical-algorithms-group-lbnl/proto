.ci-runner:
  tags:
    - cori

.common_script: &label
  - module swap PrgEnv-intel PrgEnv-gnu
  - module load cmake
  - module swap gcc gcc/8.3.0
  - export SLURM_CPU_BIND="cores"
  - git submodule init
  - git submodule update
  
variables:
  SCHEDULER_PARAMETERS:  "-C haswell -q regular -n 1 -t 00:05:00"

stages:
  - build
  - test

configure_mpi:
    stage: build
    extends:
      - .ci-runner
    before_script:
      - *label
      - module load cray-mpich
      - module load cray-hdf5-parallel
      - export PE_CXX_PKGCONFIG_LIBS=hdf5_hl_cpp:hdf5_cpp
      - export PE_HDF5_CXX_PKGCONFIG_LIBS=hdf5_hl_cpp:hdf5_cpp
    script:
      - cmake -S . -B mpi_build -DENABLE_MPI=ON -DCMAKE_VERBOSE_MAKEFILE:BOOL=OFF
      - cmake --build mpi_build --parallel
    artifacts:
      paths:
        - mpi_build/*

configure_cuda:
    stage: build
    extends:
      - .ci-runner
    before_script:
      - *label
      - module load cray-hdf5
      - module load cgpu
      - module load cuda
    script:
      - cmake -S . -B cuda_build -DENABLE_CUDA=ON -DCMAKE_VERBOSE_MAKEFILE:BOOL=OFF
      - cmake --build cuda_build --parallel
    artifacts:
      paths:
        - cuda_build/*

mpi_execute:
    stage: test
    extends:
      - .ci-runner
    needs: [configure_mpi]
    variables:
      SCHEDULER_PARAMETERS: "-N 1 -q regular -C haswell -n 4 -c 2 -t 00:10:00"
    before_script:
      - *label
    script:
      - mpi_build/bin/BoxTests

cuda_execute:
    stage: test
    extends:
      - .ci-runner
    needs: [configure_cuda]
    variables:
        SCHEDULER_PARAMETERS: "-M escori -N 1 -q regular -C gpu -G 1 -c 1 -t 00:10:00"
    before_script:
      - *label
      - module load cgpu
      - module load cuda
    script:
      - cuda_build/bin/BoxTests
